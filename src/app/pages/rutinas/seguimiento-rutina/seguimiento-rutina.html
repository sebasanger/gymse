<mat-stepper orientation="vertical">
  <mat-step
    *ngFor="let ejercicioEntrenamiento of ejerciciosEntrenamientos"
    [stepControl]="getForm(ejercicioEntrenamiento.id)"
  >
    <ng-template matStepLabel>
      {{ ejercicioEntrenamiento.ejercicio.nombre }}
    </ng-template>

    <!-- CARD PRINCIPAL -->
    <mat-card class="ejercicio-card">
      <!-- Carousel -->
      <mat-tab-group mat-stretch-tabs="false" animationDuration="300ms">
        <mat-tab *ngFor="let foto of ejercicioEntrenamiento.ejercicio.fotos">
          <ng-template mat-tab-label> Foto </ng-template>
          <img [src]="foto.foto" class="media-display" />
        </mat-tab>

        <mat-tab *ngFor="let vid of ejercicioEntrenamiento.ejercicio.videos">
          <ng-template mat-tab-label> Video </ng-template>
          <video class="media-display" [src]="vid.video" controls></video>
        </mat-tab>
      </mat-tab-group>

      <!-- Info -->
      <mat-card-content>
        <h2 class="ej-titulo">{{ ejercicioEntrenamiento.ejercicio.nombre }}</h2>
        <p class="ej-desc">{{ ejercicioEntrenamiento.ejercicio.descripcion }}</p>

        <p>
          <strong>Categoría:</strong>
          {{ ejercicioEntrenamiento.ejercicio.categoria.categoria }}
        </p>
      </mat-card-content>
    </mat-card>

    <!-- PROGRESO -->
    @if (ejercicioEntrenamiento.progreso) {

    <mat-card class="progreso-card">
      <mat-card-header class="progreso-header">
        <mat-card-title>Progreso anterior</mat-card-title>
        <mat-card-subtitle>
          {{ ejercicioEntrenamiento.progreso.cantidadSeries }} series registradas
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <p class="mb-2">
          <strong>Ejercicio:</strong>
          {{ ejercicioEntrenamiento.progreso.ejercicio.nombre }}
        </p>

        @for (serie of ejercicioEntrenamiento.progreso.series; track serie.id; let i = $index) {
        <div class="progreso-serie">
          <strong>Serie {{ i + 1 }}</strong>
          <span>{{ serie.repeticiones }} reps — {{ serie.peso }} kg</span>
        </div>
        }
      </mat-card-content>

      <div class="progreso-acciones">
        <button
          mat-raised-button
          color="warn"
          (click)="eliminarProgreso(ejercicioEntrenamiento.progreso.id)"
        >
          Eliminar progreso
        </button>
      </div>
    </mat-card>

    } @else {
    <!-- FORM SERIES -->
    <form [formGroup]="getForm(ejercicioEntrenamiento.id)" class="form-ejercicio">
      <div formArrayName="ejercicioEntrenamiento" class="series-container">
        <h3 class="subtitulo">Series</h3>
        <mat-divider></mat-divider>

        <div
          class="serie-card"
          *ngFor="
            let serie of getSeriesFormArray(ejercicioEntrenamiento.id).controls;
            let i = index
          "
          [formGroupName]="i"
        >
          <div class="serie-header">
            <strong>Serie {{ i + 1 }}</strong>

            <button
              mat-icon-button
              color="warn"
              (click)="eliminarSerie(ejercicioEntrenamiento.id, i)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="inputs-row">
            <mat-form-field appearance="outline">
              <mat-label>Peso</mat-label>
              <input matInput type="number" formControlName="peso" />
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Repeticiones</mat-label>
              <input matInput type="number" formControlName="repeticiones" />
            </mat-form-field>
          </div>
        </div>

        <button
          mat-stroked-button
          color="primary"
          class="btn-add"
          (click)="agregarSerie(ejercicioEntrenamiento.id)"
        >
          <mat-icon>add</mat-icon>
          Agregar serie
        </button>
      </div>

      <div class="acciones-form">
        <button mat-flat-button color="primary" matStepperNext>Siguiente</button>

        <button
          mat-flat-button
          color="accent"
          (click)="guardarProgresoEjercicio(ejercicioEntrenamiento)"
        >
          Guardar
        </button>
      </div>
    </form>
    }
  </mat-step>

  <mat-step>
    <ng-template matStepLabel>Finalizar</ng-template>
    <p>Ya completaste todos los ejercicios.</p>
    <button mat-button matStepperPrevious>Atrás</button>
  </mat-step>
</mat-stepper>
